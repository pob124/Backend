<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì´ë©”ì¼ ì´ˆì•ˆ ëª©ë¡</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .email-card {
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
    }
    .email-card h3 { margin: 0; }
    .email-card p { margin: 5px 0; white-space: pre-line; }
    .email-actions {
      margin-top: 10px;
    }
    button {
      margin-right: 10px;
      padding: 5px 10px;
    }
    .feedback-input {
      border: 1px solid #ddd;
      padding: 10px;
      background-color: #f9f9f9;
      border-radius: 4px;
    }
    .feedback-input textarea {
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 8px;
      font-family: inherit;
    }
  </style>
</head>
<body>
  <h1>ì´ë©”ì¼ ì´ˆì•ˆ ëª©ë¡</h1>

  <div>
    <label>Session ID: <input type="text" id="sessionIdInput" style="width: 400px;" /></label>
    <button onclick="loadDrafts()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <button onclick="sendAll()">ì¼ê´„ ì „ì†¡</button>
    <button onclick="rewriteSelectedEmails()">ì„ íƒ ì¬ì‘ì„±</button>
    <button onclick="checkRedisKeys()">Redis í‚¤ í™•ì¸</button>
  </div>

  <div id="draftList" style="margin-top: 20px;"></div>

  <script>
    async function loadDrafts() {
      const sessionId = document.getElementById('sessionIdInput').value.trim();
      if (!sessionId) {
        alert('Session IDë¥¼ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }
      const res = await fetch(`/emails/api/drafts?sessionId=${sessionId}`); 
      const emails = await res.json();
      const list = document.getElementById('draftList');
      list.innerHTML = '';

      emails.forEach((item) => {
        const email = item.email;
        const uuid = item.uuid;
        const isCancelled = item.isCancelled || false;

        const card = document.createElement('div');
        card.className = 'email-card';
        
        const cardStyle = isCancelled ? 'border-left: 4px solid #ff6b6b; background-color: #fff5f5;' : '';
        
        card.innerHTML = `
          <div style="${cardStyle}">
            <h3>${email.subject}</h3>
            <p><strong>To:</strong> ${email.contactEmail}</p>
            ${isCancelled ? '<p style="color: #ff6b6b; font-weight: bold;">âš ï¸ ì·¨ì†Œëœ ì´ë©”ì¼ (ì¬ì‘ì„± ëŒ€ê¸° ì¤‘)</p>' : ''}
            <p>${email.body}</p>
            <div class="email-actions">
              ${!isCancelled ? `<button onclick="sendEmail('${uuid}')">ë³´ë‚´ê¸°</button>` : ''}
              <button onclick="createFollowupEmail('${uuid}', ${email.projectId}, ${email.leadId})">í›„ì† ë©”ì¼</button>
              <input type="checkbox" class="cancel-checkbox" data-uuid="${uuid}" data-email='${JSON.stringify(email)}' ${isCancelled ? 'disabled' : ''}>
              <label>ì¬ì‘ì„± ì„ íƒ</label>
            </div>
            <div id="feedback-input-${uuid}" class="feedback-input" style="display: none; margin-top: 10px;">
              <textarea placeholder="ì¬ì‘ì„± ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì œëª©ì´ ë„ˆë¬´ ì¼ë°˜ì ì„, ë‚´ìš©ì´ êµ¬ì²´ì ì´ì§€ ì•ŠìŒ, í†¤ì´ ë¶€ì ì ˆí•¨ ë“±)" rows="3" style="width: 100%; margin-bottom: 5px;"></textarea>
            </div>
          </div>
        `;
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì§ì ‘ ì¶”ê°€
        const checkbox = card.querySelector('.cancel-checkbox');
        checkbox.addEventListener('change', function() {
          toggleFeedbackInput(uuid);
        });
        
        list.appendChild(card);
      });
    }

    async function sendEmail(uuid) {
      const res = await fetch(`/emails/send/${uuid}`, { method: 'POST' });
      if (res.ok) alert('ë©”ì¼ ì „ì†¡ ì™„ë£Œ');
      else alert('ì „ì†¡ ì‹¤íŒ¨');
    }

    async function sendAll() {
      const sessionId = document.getElementById('sessionIdInput').value.trim();
      if (!sessionId) {
        alert('Session IDë¥¼ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }
      const res = await fetch(`/emails/send?sessionId=${sessionId}`, { method: 'POST' });
      if (res.ok) alert('ì¼ê´„ ì „ì†¡ ì™„ë£Œ');
      else alert('ì „ì†¡ ì‹¤íŒ¨');
    }

    function toggleFeedbackInput(uuid) {
      console.log('toggleFeedbackInput called with uuid:', uuid);
      const feedbackDiv = document.getElementById(`feedback-input-${uuid}`);
      const checkbox = document.querySelector(`input[data-uuid="${uuid}"]`);
      
      console.log('feedbackDiv:', feedbackDiv);
      console.log('checkbox:', checkbox);
      console.log('checkbox.checked:', checkbox ? checkbox.checked : 'checkbox not found');
      
      if (feedbackDiv && checkbox) {
        if (checkbox.checked) {
          feedbackDiv.style.display = 'block';
          console.log('Feedback input shown for uuid:', uuid);
        } else {
          feedbackDiv.style.display = 'none';
          // í”¼ë“œë°± ì…ë ¥ê°’ ì´ˆê¸°í™”
          feedbackDiv.querySelector('textarea').value = '';
          console.log('Feedback input hidden for uuid:', uuid);
        }
      } else {
        console.error('Elements not found for uuid:', uuid);
      }
    }

    async function rewriteSelectedEmails() {
      const rewriteButton = document.querySelector('button[onclick="rewriteSelectedEmails()"]');
      if (rewriteButton) {
        rewriteButton.disabled = true;
        rewriteButton.textContent = 'ì¬ì‘ì„± ì¤‘...';
      }
      
      // ì¬ì‘ì„± ì‹¤íŒ¨ ì¹´ìš´í„° ì´ˆê¸°í™” (ìƒˆë¡œìš´ ì¬ì‘ì„± ì‹œë„ ì‹œì‘)
      try {
        await fetch('/emails/reset-rewrite-failures', { method: 'POST' });
        console.log('âœ… ì¬ì‘ì„± ì‹¤íŒ¨ ì¹´ìš´í„° ì´ˆê¸°í™” ì™„ë£Œ');
      } catch (error) {
        console.log('âš ï¸ ì¬ì‘ì„± ì‹¤íŒ¨ ì¹´ìš´í„° ì´ˆê¸°í™” ì‹¤íŒ¨ (ë¬´ì‹œ)', error);
      }
      
      const checkboxes = document.querySelectorAll('.cancel-checkbox:checked');
      if (checkboxes.length === 0) {
        alert('ì¬ì‘ì„±í•  ì´ë©”ì¼ì„ ì„ íƒí•˜ì„¸ìš”');
        if (rewriteButton) {
          rewriteButton.disabled = false;
          rewriteButton.textContent = 'ì„ íƒ ì¬ì‘ì„±';
        }
        return;
      }

      const sessionId = document.getElementById('sessionIdInput').value.trim();
      if (!sessionId) {
        alert('Session IDë¥¼ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }

      // ì„ íƒëœ ì´ë©”ì¼ë“¤ì˜ ì •ë³´ ìˆ˜ì§‘
      const selectedEmails = [];
      checkboxes.forEach(checkbox => {
        const email = JSON.parse(checkbox.dataset.email);
        const uuid = checkbox.dataset.uuid;
        const feedbackInput = document.getElementById(`feedback-input-${uuid}`);
        const feedback = feedbackInput.querySelector('textarea').value.trim();
        
        if (!feedback) {
          alert(`"${email.subject}" ì´ë©”ì¼ì˜ ì¬ì‘ì„± ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”`);
          return;
        }
        
        selectedEmails.push({ uuid, email, feedback });
      });

      if (selectedEmails.length === 0) {
        return;
      }

      try {
        // ê° ì´ë©”ì¼ë³„ë¡œ ì·¨ì†Œ ë° ì¬ì‘ì„± ìš”ì²­
        let successCount = 0;
        let totalCount = selectedEmails.length;
        
        for (const { uuid, email, feedback } of selectedEmails) {
          console.log(`ğŸ”„ ì¬ì‘ì„± ìš”ì²­ ì‹œì‘: ${uuid}`);
          console.log(`ğŸ“ í”¼ë“œë°±: ${feedback}`);
          
          try {
            const res = await fetch(`/emails/cancel/${uuid}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ cancelReason: feedback })
            });
            
            console.log(`ğŸ“¡ ì‘ë‹µ ìƒíƒœ: ${res.status} ${res.statusText}`);
            
            if (!res.ok) {
              const errorText = await res.text();
              console.error(`âŒ ì´ë©”ì¼ ì¬ì‘ì„± ìš”ì²­ ì‹¤íŒ¨: ${uuid}`, errorText);
            } else {
              const successText = await res.text();
              console.log(`âœ… ì´ë©”ì¼ ì¬ì‘ì„± ìš”ì²­ ì„±ê³µ: ${uuid}`, successText);
              successCount++;
            }
          } catch (error) {
            console.error(`âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${uuid}`, error);
          }
        }
        
        if (successCount > 0) {
          alert(`${successCount}/${totalCount}ê°œì˜ ì´ë©”ì¼ ì¬ì‘ì„± ìš”ì²­ì´ ì„±ê³µí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ëª©ë¡ì´ ìƒˆë¡œê³ ì¹¨ë©ë‹ˆë‹¤.`);
          
          // ì²´í¬ë°•ìŠ¤ í•´ì œ ë° í”¼ë“œë°± ì…ë ¥ ìˆ¨ê¸°ê¸°
          checkboxes.forEach(checkbox => {
            checkbox.checked = false;
            const uuid = checkbox.dataset.uuid;
            toggleFeedbackInput(uuid);
          });
          
          // 3ì´ˆ í›„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ë‚´ìš© ì—…ë°ì´íŠ¸ ë°©ì‹ì´ë¯€ë¡œ cleanup ë¶ˆí•„ìš”)
          setTimeout(async () => {
            await loadDrafts();
          }, 3000);
        } else {
          alert('ì¬ì‘ì„± ìš”ì²­ì´ ëª¨ë‘ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. 4ë²ˆ ì—°ì† ì‹¤íŒ¨ ì‹œ ìë™ìœ¼ë¡œ ê±´ë„ˆëœë‹ˆë‹¤.');
        }
        
        // ë²„íŠ¼ ìƒíƒœ ë³µì›
        if (rewriteButton) {
          rewriteButton.disabled = false;
          rewriteButton.textContent = 'ì„ íƒ ì¬ì‘ì„±';
        }
        
      } catch (error) {
        alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }

    async function createFollowupEmail(uuid, projectId, leadId) {
      const followupReason = prompt('í›„ì† ë©”ì¼ ìƒì„± ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì¶”ê°€ ì •ë³´ ì œê³µ, ë¯¸íŒ… ìš”ì²­, ì œì•ˆì„œ ë³´ì™„ ë“±):');
      
      if (!followupReason) {
        alert('í›„ì† ë©”ì¼ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        console.log(`ğŸ”„ Follow-up Email ìƒì„± ìš”ì²­ ì‹œì‘: ${uuid}`);
        console.log(`ğŸ“ í›„ì† ì‚¬ìœ : ${followupReason}`);
        
        const res = await fetch('/emails/followup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            projectId: projectId,
            leadId: leadId,
            originalEmailId: uuid,
            followupReason: followupReason
          })
        });
        
        console.log(`ğŸ“¡ ì‘ë‹µ ìƒíƒœ: ${res.status} ${res.statusText}`);
        
        if (!res.ok) {
          const errorText = await res.text();
          console.error(`âŒ Follow-up Email ìƒì„± ì‹¤íŒ¨:`, errorText);
          alert('Follow-up Email ìƒì„± ì‹¤íŒ¨: ' + errorText);
        } else {
          const successText = await res.text();
          console.log(`âœ… Follow-up Email ìƒì„± ì„±ê³µ:`, successText);
          alert('Follow-up Emailì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ëª©ë¡ì´ ìƒˆë¡œê³ ì¹¨ë©ë‹ˆë‹¤.');
          
          // 3ì´ˆ í›„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          setTimeout(async () => {
            await loadDrafts();
          }, 3000);
        }
      } catch (error) {
        console.error(`âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:`, error);
        alert('Follow-up Email ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }

    async function checkRedisKeys() {
      try {
        const res = await fetch('/emails/debug/redis-keys');
        const data = await res.json();
        console.log('ğŸ” Redis í‚¤ ì •ë³´:', data);
        alert(`Redis í‚¤ ì •ë³´:\nDraft: ${data.draftKeys}ê°œ\nCancelled: ${data.cancelledKeys}ê°œ\nSession: ${data.sessionKeys}ê°œ`);
      } catch (error) {
        console.error('Redis í‚¤ í™•ì¸ ì‹¤íŒ¨:', error);
        alert('Redis í‚¤ í™•ì¸ ì‹¤íŒ¨: ' + error.message);
      }
    }

    // cleanupAndReload í•¨ìˆ˜ ì œê±° (ë‚´ìš© ì—…ë°ì´íŠ¸ ë°©ì‹ì—ì„œëŠ” ë¶ˆí•„ìš”)

    window.onload = () => {
      const params = new URLSearchParams(window.location.search);
      const sessionId = params.get('sessionId');
      if (sessionId) {
        document.getElementById('sessionIdInput').value = sessionId;
        loadDrafts();
      }
    };
  </script>
</body>
</html>